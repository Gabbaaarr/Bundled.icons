{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Bundled.icons</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .collection-active {
      background-color: #E0E7FF;
      color: #4338CA;
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
    }
    .section-highlight {
      box-shadow: 0 10px 15px -3px rgba(67, 56, 202, 0.2);
    }
    .icon-copied {
      background-color: #4338CA !important;
      color: white !important;
    }
    .icon-copied img {
      filter: brightness(0) invert(1);
    }
    .icon-selected {
      border: 2px solid #4338CA !important;
      background-color: #E0E7FF !important;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
    }
    .glass-card h2 {
      color: rgba(255, 255, 255, 0.9);
    }
    .glass-card .bg-indigo-100 {
      background: rgba(99, 102, 241, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }
    .glass-card .icon-button {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .glass-card .icon-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 3px;
    }
    .bg-solid {
      background-color: rgb(251, 249, 249);
    }
    .bg-gradient {
      background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
    }
    .bg-grid {
      background: none;
    }
    .right-panel {
      transition: all 0.3s ease-in-out;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 600px;
      height: 600px;
      background: white;
      border-radius: 16px;
      padding: 1.5rem;
      z-index: 1000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .right-panel-hidden {
      transform: translate(-50%, -50%) scale(0.8);
      opacity: 0;
      pointer-events: none;
    }
    .right-panel-visible {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
      pointer-events: all;
    }
    .popup-content {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      height: 100%;
      overflow-y: auto;
    }
    .popup-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      position: relative;
    }
    .popup-controls {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      flex: 1;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .control-group label {
      font-size: 0.7rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.2rem;
    }
    .control-group button {
      padding: 0.4rem 0.6rem;
      font-size: 0.7rem;
      transition: all 0.2s ease;
    }
    .control-group button:hover {
      transform: translateY(-1px);
    }
    .icon-preview {
      width: 200px;
      height: 200px;
      padding: 1rem;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      background: #F9FAFB;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .icon-preview:hover {
      border-color: #D1D5DB;
      background: #F3F4F6;
    }
    .icon-preview img {
      max-width: 120px;
      max-height: 120px;
      object-fit: contain;
      transform: none;
    }
    .zoom-controls {
      position: absolute;
      top: 0.5rem;
      left: 0.5rem;
      display: flex;
      gap: 0.5rem;
    }
    .zoom-button {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      color: #6B7280;
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      transition: all 0.2s ease;
    }
    .zoom-button:hover {
      background: #F3F4F6;
      color: #374151;
    }
    .size-button {
      padding: 0.3rem 0.5rem !important;
      font-size: 0.65rem !important;
    }
    #custom-size {
      width: 60px;
      padding: 0.3rem;
      font-size: 0.65rem;
    }
    .copy-button, .download-button {
      padding: 0.4rem 0.6rem !important;
      font-size: 0.7rem !important;
    }
    #icon-path {
      font-size: 0.7rem;
      color: #6B7280;
      text-align: center;
    }
    #close-panel {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      color: #6B7280;
      transition: all 0.2s ease;
    }
    #close-panel:hover {
      background: #F3F4F6;
      color: #374151;
    }
    #reset-button {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      color: #6B7280;
      transition: all 0.2s ease;
    }
    #reset-button:hover {
      background: #F3F4F6;
      color: #374151;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out;
      backdrop-filter: blur(2px);
    }
    .overlay-visible {
      opacity: 1;
      visibility: visible;
    }
    @media (max-width: 768px) {
      .right-panel {
        width: 90%;
        height: 90%;
        max-height: 500px;
        max-width: 500px;
        border-radius: 12px;
        padding: 1rem;
      }
      .icon-preview {
        width: 150px;
        height: 150px;
      }
      .icon-preview img {
        max-width: 100px;
        max-height: 100px;
      }
      .control-group {
        gap: 0.5rem;
      }
      .control-group label {
        font-size: 0.75rem;
      }
      .control-group button {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
      }
      .size-button {
        padding: 0.3rem 0.5rem !important;
        font-size: 0.7rem !important;
      }
      #custom-size {
        width: 70px;
        padding: 0.3rem;
        font-size: 0.7rem;
      }
      .copy-button, .download-button {
        padding: 0.4rem 0.6rem !important;
        font-size: 0.75rem !important;
      }
    }
    .glass-sidebar {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    .glass-sidebar a {
      color: rgba(255, 255, 255, 0.8);
      transition: all 0.3s ease;
    }
    .glass-sidebar a:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
      color: rgba(255, 255, 255, 1);
    }
    .glass-sidebar .collection-active {
      background: rgba(99, 102, 241, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }
    .glass-sidebar li {
      transition: all 0.3s ease;
      color: rgba(255, 255, 255, 0.7);
    }
    .glass-sidebar li:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
      color: rgba(255, 255, 255, 1);
    }
    .glass-sidebar li span {
      transition: all 0.3s ease;
    }
    .glass-sidebar li:hover span {
      opacity: 0.7;
    }
    .glass-search {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .glass-search:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .glass-search::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    .glass-search:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .glass-button {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .glass-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .glass-button:active {
      transform: translateY(0);
    }
    .icon-button {
      position: relative;
    }
    .icon-button:hover {
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }
    .show-more-btn {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .show-more-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr); /* 10 icons per row */
      gap: 0.75rem; /* reduced gap between icons */
    }
    .icon-button {
      width: 90px;
      height: 90px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.7);
      border-radius: 16px;
      transition: box-shadow 0.2s, background 0.2s;
      cursor: pointer;
      overflow: hidden;
      position: relative;
    }
    .icon-button img {
      width: 40px;
      height: 40px;
      margin-bottom: 0.5rem;
      object-fit: contain;
    }
    .icon-button .icon-label {
      width: 80px;
      text-align: center;
      font-size: 0.85rem;
      color: #374151;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
      margin: 0 auto;
    }
    .icon-button:hover {
      background: #f3f4f6;
      box-shadow: 0 2px 8px rgba(67,56,202,0.08);
    }
    @media (max-width: 1200px) {
      .icon-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    @media (max-width: 900px) {
      .icon-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    @media (max-width: 600px) {
      .icon-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .icon-button {
        width: 70px;
        height: 70px;
      }
      .icon-button img {
        width: 28px;
        height: 28px;
      }
      .icon-button .icon-label {
        width: 60px;
        font-size: 0.75rem;
      }
    }
    .color-picker-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .color-picker-container input[type="color"] {
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      cursor: pointer;
    }
    .color-picker-container input[type="text"] {
      flex: 1;
      padding: 0.3rem;
      font-size: 0.65rem;
      border: 1px solid #E5E7EB;
      border-radius: 6px;
    }
    .rotation-slider, .thickness-slider {
      width: 100%;
      -webkit-appearance: none;
      height: 6px;
      background: #E5E7EB;
      border-radius: 3px;
      outline: none;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    .rotation-slider:hover, .thickness-slider:hover {
      opacity: 1;
    }
    .rotation-slider::-webkit-slider-thumb, .thickness-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: #4338CA;
      border-radius: 50%;
      cursor: pointer;
    }
    .rotation-slider::-moz-range-thumb, .thickness-slider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: #4338CA;
      border-radius: 50%;
      cursor: pointer;
    }
    /* Fancy Login Button */
    .fancy-login-btn {
      box-shadow: 0 0 16px 2px #ff6a00, 0 0 32px 8px #ff1744;
      filter: drop-shadow(0 0 8px #ff6a00) drop-shadow(0 0 16px #ff1744);
      background: linear-gradient(90deg, #ff9800 0%, #ff1744 100%);
      border: none;
      outline: none;
    }
    .fancy-login-btn:hover, .fancy-login-btn:focus {
      filter: drop-shadow(0 0 16px #ff9800) drop-shadow(0 0 32px #ff1744);
      background: linear-gradient(90deg, #ff1744 0%, #ff9800 100%);
      box-shadow: 0 0 32px 8px #ff1744, 0 0 16px 2px #ff9800;
      transform: scale(1.05);
    }
  </style>
</head>
<body class="bg-black text-[#1F2937]">
  <!-- Overlay -->
  <div id="overlay" class="overlay"></div>
  <div class="flex min-h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="flex flex-col w-72 glass-sidebar px-6 py-8 text-sm select-none">
      <div class="flex items-center gap-2 mb-8">
        <img alt="bundled.icons logo" class="w-6 h-6" height="24" src="{% static '/images/bundled.design.png' %}" width="24"/>
        <span class="font-semibold text-base text-white">Bundled.icons</span>
      </div>
      <!-- Go Back Arrow -->
      <button onclick="window.location.href='/'" aria-label="Go back to home" class="flex items-center gap-2 mb-6 text-white hover:text-indigo-300 transition-colors">
        <i class="fas fa-arrow-left"></i>
        <span class="text-sm font-medium">Back to Home</span>
      </button>
      <nav class="mb-10">
        <h3 class="uppercase text-xs font-semibold text-gray-400 mb-3 select-none">Browse</h3>
        <ul class="space-y-2">
          <li>
            <a class="flex items-center gap-2 rounded-md collection-active px-3 py-2 font-medium select-none" href="/"> 
              <i class="fas fa-th text-sm"></i> All Icons
            </a>
          </li>
        </ul>
      </nav>
      <nav class="flex-1 overflow-y-auto pr-1 scrollbar-thin">
        <h3 class="uppercase text-xs font-semibold text-gray-400 mb-3 select-none">Collections</h3>
        <ul class="space-y-2 text-sm font-normal" id="collections-list">
          {% for cat in categories %}
          <li class="cursor-pointer px-3 py-2 rounded-md {% if cat.name == category.name %}collection-active{% endif %}" onclick="window.location.href='/icons/{{ cat.name|slugify }}/'">
            {{ cat.name }} <span class="float-right opacity-40">{{ cat.icon_set.count }}</span>
          </li>
          {% endfor %}
        </ul>
      </nav>
      <button class="mt-6 w-full flex items-center justify-center gap-2 rounded-full bg-gradient-to-r from-orange-400 via-red-500 to-pink-500 text-white text-shadow-lg shadow-lg py-2 text-sm font-semibold fancy-login-btn transition-all duration-300 hover:scale-105 hover:shadow-2xl focus:outline-none focus:ring-2 focus:ring-orange-300" type="button">
        <i class="fas fa-user-circle text-lg"></i> Log in
      </button>
    </aside>
    <!-- Main content -->
    <main class="flex-1 p-6 overflow-y-auto scrollbar-thin">
      <!-- Top bar -->
      <div class="flex items-center gap-4 mb-6">
        <div class="flex-1 relative">
          <input id="searchInput" class="w-full rounded-lg glass-search py-2.5 pl-10 pr-4 text-sm focus:outline-none" placeholder="Search icons..." type="search" oninput="filterIcons()"/>
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
        </div>
        <div class="text-gray-400 text-xs select-none whitespace-nowrap">
          Powered by Bundled.design
        </div>
        <button aria-label="User account" class="w-10 h-10 rounded-lg glass-button flex items-center justify-center" type="button">
          <i class="fas fa-user text-gray-300"></i>
        </button>
      </div>
      <!-- Category Heading -->
      <h1 class="text-2xl font-bold mb-4 text-white">{{ category.name }}</h1>
      <!-- Icon list -->
      <div id="iconGrid" class="icon-grid overflow-y-auto max-h-[calc(100vh-120px)] pr-2">
        {% for icon in icons %}
        <div class="icon-button"
             onclick="showRightPanel('{{ icon.name }}', '{{ icon.s3_url }}', this)"
             data-icon="{{ icon.name }}"
             data-s3-url="{{ icon.s3_url }}">
          <img src="{{ icon.s3_url }}"
               alt="{{ icon.name }}" />
          <span class="icon-label">{{ icon.name|truncatechars:12 }}</span>
        </div>
        {% empty %}
        <div class="col-span-full text-center text-gray-400">No icons found in this category.</div>
        {% endfor %}
      </div>
    </main>
  </div>
  <!-- Center Popup Panel (copied from home.html for full design and functionality) -->
  <div id="right-panel" class="right-panel right-panel-hidden">
    <div class="popup-content">
      <div class="popup-preview">
        <div id="icon-path">Icons / <span class="font-semibold" id="icon-name"></span></div>
        <div class="icon-preview" id="icon-preview">
          <div class="zoom-controls">
            <button id="zoom-in" class="zoom-button" aria-label="Zoom in" type="button">
              <i class="fas fa-plus"></i>
            </button>
            <button id="zoom-out" class="zoom-button" aria-label="Zoom out" type="button">
              <i class="fas fa-minus"></i>
            </button>
          </div>
          <img id="preview-img" class="max-w-full max-h-full" width="120" height="120" />
          <button id="reset-button" aria-label="Reset customizations" type="button">
            <i class="fas fa-undo"></i>
          </button>
        </div>
      </div>
      <div class="popup-controls">
        <div class="control-group">
          <label for="icon-color-picker">Icon Color</label>
          <div class="color-picker-container">
            <input type="color" id="icon-color-picker" value="#000000" />
            <input type="text" id="icon-color-hex" placeholder="Hex code" value="#000000" />
          </div>
        </div>
        <div class="control-group">
          <label>Background</label>
          <div class="flex items-center gap-2 flex-wrap">
            <button class="flex items-center justify-center gap-1 rounded-lg border border-blue-400 bg-blue-50 px-3 py-2 text-sm text-blue-700 bg-button" type="button" data-bg="none"><i class="fas fa-globe"></i> None</button>
            <button class="flex items-center justify-center gap-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 bg-button" type="button" data-bg="solid">Solid</button>
            <button class="flex items-center justify-center gap-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 bg-button" type="button" data-bg="gradient"><i class="fas fa-palette"></i> Gradient</button>
          </div>
          <div id="solid-bg-controls" class="color-picker-container mt-1" style="display: none;">
            <input type="color" id="solid-bg-color" value="#f0f0f0" />
            <input type="text" id="solid-bg-hex" placeholder="Hex code" value="#f0f0f0" />
          </div>
          <div id="gradient-bg-controls" class="mt-1" style="display: none;">
            <div class="color-picker-container">
              <input type="color" id="gradient-start-color" value="#a1c4fd" />
              <input type="text" id="gradient-start-hex" placeholder="Start hex" value="#a1c4fd" />
            </div>
            <div class="color-picker-container mt-1">
              <input type="color" id="gradient-end-color" value="#c2e9fb" />
              <input type="text" id="gradient-end-hex" placeholder="End hex" value="#c2e9fb" />
            </div>
          </div>
        </div>
        <div class="control-group flex flex-row gap-4 items-center">
          <div class="flex-1">
            <label for="rotation-slider">Rotation</label>
            <input type="range" id="rotation-slider" min="0" max="360" value="0" class="rotation-slider" />
          </div>
          <div class="flex-1">
            <label for="thickness-slider">Outline Thickness</label>
            <input type="range" id="thickness-slider" min="0" max="10" value="1" step="0.1" class="thickness-slider" />
          </div>
        </div>
        <div class="control-group">
          <label>Size</label>
          <div class="flex items-center gap-2 flex-wrap">
            <button class="rounded-lg border border-gray-300 bg-white size-button" type="button" data-size="48">48px</button>
            <button class="rounded-lg border border-gray-300 bg-white size-button" type="button" data-size="64">64px</button>
            <button class="rounded-lg border border-gray-400 bg-blue-50 text-blue-700 size-button" type="button" data-size="128">128px</button>
            <button class="rounded-lg border border-blue-400 bg-blue-50 text-blue-700 size-button" type="button" data-size="256">256px</button>
            <input class="rounded-lg border border-gray-300" id="custom-size" max="500" min="1" type="number" value="256" />
          </div>
        </div>
        <div class="control-group">
          <label>Actions</label>
          <div class="flex items-center gap-2 flex-wrap">
            <button class="flex items-center gap-1 rounded-lg border border-gray-300 bg-white copy-button" type="button" data-type="base64"><i class="fas fa-copy"></i> Copy Icon</button>
            <button class="flex items-center gap-1 rounded-lg border border-gray-300 bg-white download-button" type="button" data-type="png"><i class="fas fa-download"></i> Download PNG</button>
            <button class="flex items-center gap-1 rounded-lg bg-blue-600 text-white download-button" type="button" data-type="svg"><i class="fas fa-download"></i> Download SVG</button>
          </div>
        </div>
      </div>
    </div>
    <button id="close-panel" aria-label="Close" onclick="hideRightPanel()">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <script>
    // --- BEGIN: Popup Panel Logic Parity with home.html ---
    let currentIcon = null;
    let currentIconUrl = '';
    let currentColor = '#000000';
    let currentRotation = 0;
    let currentSize = 256;
    let currentBg = 'none';
    let solidBgColor = '#f0f0f0';
    let gradientStartColor = '#a1c4fd';
    let gradientEndColor = '#c2e9fb';
    let isPanelInitialized = false;
    let currentZoom = 1;
    let currentThickness = 1;

    document.addEventListener('DOMContentLoaded', function() {
      // Hide the panel by default (like home.html)
      const panel = document.getElementById('right-panel');
      if (panel) {
        panel.style.display = 'none';
      }
      attachPanelEventListeners();
      isPanelInitialized = true;
    });

    function resetPanelState() {
      const prevIcon = currentIcon;
      const prevIconUrl = currentIconUrl;
      currentIcon = null;
      currentIconUrl = '';
      currentColor = '#000000';
      currentRotation = 0;
      currentSize = 256;
      currentBg = 'none';
      solidBgColor = '#f0f0f0';
      gradientStartColor = '#a1c4fd';
      gradientEndColor = '#c2e9fb';
      currentZoom = 1;
      currentThickness = 1;
      const colorPicker = document.getElementById('icon-color-picker');
      const colorHex = document.getElementById('icon-color-hex');
      const rotationSlider = document.getElementById('rotation-slider');
      const thicknessSlider = document.getElementById('thickness-slider');
      const sizeInput = document.getElementById('custom-size');
      const solidBgColorPicker = document.getElementById('solid-bg-color');
      const solidBgHex = document.getElementById('solid-bg-hex');
      const gradientStartColorPicker = document.getElementById('gradient-start-color');
      const gradientStartHex = document.getElementById('gradient-start-hex');
      const gradientEndColorPicker = document.getElementById('gradient-end-color');
      const gradientEndHex = document.getElementById('gradient-end-hex');
      const bgButtons = document.querySelectorAll('.bg-button');
      const sizeButtons = document.querySelectorAll('.size-button');
      if (colorPicker && colorHex) {
        colorPicker.value = currentColor;
        colorHex.value = currentColor;
      }
      if (rotationSlider) rotationSlider.value = currentRotation;
      if (thicknessSlider) thicknessSlider.value = currentThickness;
      if (sizeInput) sizeInput.value = currentSize;
      if (solidBgColorPicker && solidBgHex) {
        solidBgColorPicker.value = solidBgColor;
        solidBgHex.value = solidBgColor;
      }
      if (gradientStartColorPicker && gradientStartHex) {
        gradientStartColorPicker.value = gradientStartColor;
        gradientStartHex.value = gradientStartColor;
      }
      if (gradientEndColorPicker && gradientEndHex) {
        gradientEndColorPicker.value = gradientEndColor;
        gradientEndHex.value = gradientEndColor;
      }
      bgButtons.forEach(btn => {
        btn.classList.remove('border-blue-400', 'bg-blue-50', 'text-blue-700');
        btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
        if (btn.dataset.bg === 'none') {
          btn.classList.add('border-blue-400', 'bg-blue-50', 'text-blue-700');
        }
      });
      sizeButtons.forEach(btn => {
        btn.classList.remove('border-blue-400', 'bg-blue-50', 'text-blue-700');
        btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
        if (btn.dataset.size === '256') {
          btn.classList.add('border-blue-400', 'bg-blue-50', 'text-blue-700');
        }
      });
      document.getElementById('solid-bg-controls').style.display = 'none';
      document.getElementById('gradient-bg-controls').style.display = 'none';
      if (prevIcon && prevIconUrl) {
        currentIcon = prevIcon;
        currentIconUrl = prevIconUrl;
      }
      updatePreview();
    }

    function attachPanelEventListeners() {
      const colorPicker = document.getElementById('icon-color-picker');
      const colorHex = document.getElementById('icon-color-hex');
      const rotationSlider = document.getElementById('rotation-slider');
      const thicknessSlider = document.getElementById('thickness-slider');
      const bgButtons = document.querySelectorAll('.bg-button');
      const solidBgColorPicker = document.getElementById('solid-bg-color');
      const solidBgHex = document.getElementById('solid-bg-hex');
      const gradientStartColorPicker = document.getElementById('gradient-start-color');
      const gradientStartHex = document.getElementById('gradient-start-hex');
      const gradientEndColorPicker = document.getElementById('gradient-end-color');
      const gradientEndHex = document.getElementById('gradient-end-hex');
      const sizeButtons = document.querySelectorAll('.size-button');
      const sizeInput = document.getElementById('custom-size');
      const copyButton = document.querySelector('.copy-button');
      const downloadButtons = document.querySelectorAll('.download-button');
      const resetButton = document.getElementById('reset-button');
      const zoomInButton = document.getElementById('zoom-in');
      const zoomOutButton = document.getElementById('zoom-out');
      if (colorPicker && colorHex) {
        colorPicker.addEventListener('input', (e) => {
          currentColor = e.target.value;
          colorHex.value = currentColor;
          updatePreview();
        });
        colorHex.addEventListener('input', (e) => {
          const hexValue = e.target.value;
          if (/^#[0-9A-Fa-f]{6}$/.test(hexValue)) {
            currentColor = hexValue;
            colorPicker.value = hexValue;
            updatePreview();
          }
        });
      }
      if (rotationSlider) {
        rotationSlider.addEventListener('input', (e) => {
          currentRotation = parseInt(e.target.value);
          updatePreview();
        });
      }
      if (thicknessSlider) {
        thicknessSlider.addEventListener('input', (e) => {
          currentThickness = parseFloat(e.target.value);
          updatePreview();
        });
      }
      if (zoomInButton) {
        zoomInButton.addEventListener('click', () => {
          currentZoom = Math.min(currentZoom + 0.1, 2);
          updatePreview();
        });
      }
      if (zoomOutButton) {
        zoomOutButton.addEventListener('click', () => {
          currentZoom = Math.max(currentZoom - 0.1, 0.5);
          updatePreview();
        });
      }
      bgButtons.forEach(button => {
        button.addEventListener('click', () => {
          bgButtons.forEach(btn => {
            btn.classList.remove('border-blue-400', 'bg-blue-50', 'text-blue-700');
            btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
          });
          button.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
          button.classList.add('border-blue-400', 'bg-blue-50', 'text-blue-700');
          currentBg = button.dataset.bg;
          document.getElementById('solid-bg-controls').style.display = currentBg === 'solid' ? 'flex' : 'none';
          document.getElementById('gradient-bg-controls').style.display = currentBg === 'gradient' ? 'block' : 'none';
          updatePreview();
        });
      });
      if (solidBgColorPicker && solidBgHex) {
        solidBgColorPicker.addEventListener('input', (e) => {
          solidBgColor = e.target.value;
          solidBgHex.value = solidBgColor;
          updatePreview();
        });
        solidBgHex.addEventListener('input', (e) => {
          const hex = e.target.value;
          if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            solidBgColor = hex;
            solidBgColorPicker.value = hex;
            updatePreview();
          }
        });
      }
      if (gradientStartColorPicker && gradientStartHex) {
        gradientStartColorPicker.addEventListener('input', (e) => {
          gradientStartColor = e.target.value;
          gradientStartHex.value = gradientStartColor;
          updatePreview();
        });
        gradientStartHex.addEventListener('input', (e) => {
          const hex = e.target.value;
          if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            gradientStartColor = hex;
            gradientStartColorPicker.value = hex;
            updatePreview();
          }
        });
      }
      if (gradientEndColorPicker && gradientEndHex) {
        gradientEndColorPicker.addEventListener('input', (e) => {
          gradientEndColor = e.target.value;
          gradientEndHex.value = gradientEndColor;
          updatePreview();
        });
        gradientEndHex.addEventListener('input', (e) => {
          const hex = e.target.value;
          if (/^#[0-9A-Fa-f]{6}$/.test(hex)) {
            gradientEndColor = hex;
            gradientEndColorPicker.value = hex;
            updatePreview();
          }
        });
      }
      sizeButtons.forEach(button => {
        button.addEventListener('click', () => {
          sizeButtons.forEach(btn => {
            btn.classList.remove('border-blue-400', 'bg-blue-50', 'text-blue-700');
            btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
          });
          button.classList.remove('border-gray-300', 'bg-white', 'text-gray-700');
          button.classList.add('border-blue-400', 'bg-blue-50', 'text-blue-700');
          currentSize = parseInt(button.dataset.size);
          sizeInput.value = currentSize;
          updatePreview();
        });
      });
      if (sizeInput) {
        sizeInput.addEventListener('input', (e) => {
          const size = parseInt(e.target.value);
          if (size >= 1 && size <= 1024) {
            currentSize = size;
            sizeButtons.forEach(btn => {
              btn.classList.add('border-gray-300', 'bg-white', 'text-gray-700');
            });
            updatePreview();
          }
        });
      }
      // Copy button (SVG code)
      if (copyButton) {
        copyButton.addEventListener('click', async () => {
          try {
            const response = await fetch(currentIconUrl, {
              method: 'GET',
              mode: 'cors',
              headers: { 'Accept': 'image/svg+xml' }
            });
            if (!response.ok) throw new Error(`Failed to fetch SVG: ${response.status}`);
            let svgContent = await response.text();
            // Parse the SVG
            const parser = new DOMParser();
            const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
            const svgElement = svgDoc.documentElement;
            // Apply rotation
            if (currentRotation !== 0) {
              const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 24, 24];
              const centerX = viewBox[2] / 2;
              const centerY = viewBox[3] / 2;
              svgElement.setAttribute('transform', `rotate(${currentRotation} ${centerX} ${centerY})`);
            }
            // Apply color and thickness to all elements
            const elements = svgDoc.querySelectorAll('path, rect, circle, polyline, polygon, line');
            elements.forEach(el => {
              if (el.hasAttribute('fill') && el.getAttribute('fill') !== 'none') {
                el.setAttribute('fill', currentColor);
              }
              if (el.hasAttribute('stroke') && el.getAttribute('stroke') !== 'none') {
                el.setAttribute('stroke', currentColor);
                el.setAttribute('stroke-width', currentThickness);
              } else {
                el.setAttribute('stroke', currentColor);
                el.setAttribute('stroke-width', currentThickness);
              }
            });
            // Add background if needed
            if (currentBg === 'solid' || currentBg === 'gradient') {
              const rect = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'rect');
              rect.setAttribute('width', '100%');
              rect.setAttribute('height', '100%');
              rect.setAttribute('fill', currentBg === 'solid' ? solidBgColor : `url(#gradient)`);
              svgElement.insertBefore(rect, svgElement.firstChild);
              if (currentBg === 'gradient') {
                const defs = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const gradient = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                gradient.setAttribute('id', 'gradient');
                gradient.setAttribute('x1', '0%');
                gradient.setAttribute('y1', '0%');
                gradient.setAttribute('x2', '100%');
                gradient.setAttribute('y2', '100%');
                const stop1 = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop1.setAttribute('offset', '0%');
                stop1.setAttribute('stop-color', gradientStartColor);
                const stop2 = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop2.setAttribute('offset', '100%');
                stop2.setAttribute('stop-color', gradientEndColor);
                gradient.appendChild(stop1);
                gradient.appendChild(stop2);
                defs.appendChild(gradient);
                svgElement.insertBefore(defs, svgElement.firstChild);
              }
            }
            // Remove any previous transform and wrap for rotation
            svgElement.removeAttribute('transform');
            let wrapper = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'g');
            while (svgElement.firstChild) {
              wrapper.appendChild(svgElement.firstChild);
            }
            if (currentRotation !== 0) {
              const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 24, 24];
              const centerX = viewBox[2] / 2;
              const centerY = viewBox[3] / 2;
              wrapper.setAttribute('transform', `rotate(${currentRotation} ${centerX} ${centerY})`);
            }
            svgElement.appendChild(wrapper);
            // Apply zoom by adjusting viewBox
            if (currentZoom !== 1) {
              const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 24, 24];
              const newWidth = viewBox[2] / currentZoom;
              const newHeight = viewBox[3] / currentZoom;
              const newX = viewBox[0] + (viewBox[2] - newWidth) / 2;
              const newY = viewBox[1] + (viewBox[3] - newHeight) / 2;
              svgElement.setAttribute('viewBox', `${newX} ${newY} ${newWidth} ${newHeight}`);
            }
            // Set width and height attributes based on currentSize
            svgElement.setAttribute('width', `${currentSize}`);
            svgElement.setAttribute('height', `${currentSize}`);
            // Serialize and copy SVG code
            svgContent = new XMLSerializer().serializeToString(svgDoc.documentElement);
            await navigator.clipboard.writeText(svgContent);
            const originalContent = copyButton.innerHTML;
            copyButton.textContent = 'Copied!';
            setTimeout(() => {
              copyButton.innerHTML = originalContent;
            }, 1000);
          } catch (err) {
            copyButton.textContent = 'Failed!';
            setTimeout(() => {
              copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy Icon';
            }, 1000);
          }
        });
      }
      if (downloadButtons[0] && !downloadButtons[0].hasEventListener) {
        downloadButtons.forEach(button => {
          button.addEventListener('click', async () => {
            const type = button.dataset.type;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
            button.disabled = true;
            try {
              if (type === 'png') {
                const canvas = document.createElement('canvas');
                canvas.width = currentSize;
                canvas.height = currentSize;
                const ctx = canvas.getContext('2d');
                if (currentBg === 'solid') {
                  ctx.fillStyle = solidBgColor;
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                } else if (currentBg === 'gradient') {
                  const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                  gradient.addColorStop(0, gradientStartColor);
                  gradient.addColorStop(1, gradientEndColor);
                  ctx.fillStyle = gradient;
                  ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.src = currentIconUrl;
                await new Promise((resolve, reject) => {
                  img.onload = resolve;
                  img.onerror = () => reject(new Error('Failed to load icon'));
                });
                const iconCanvas = document.createElement('canvas');
                iconCanvas.width = currentSize;
                iconCanvas.height = currentSize;
                const iconCtx = iconCanvas.getContext('2d');
                iconCtx.translate(currentSize / 2, currentSize / 2);
                iconCtx.rotate((currentRotation * Math.PI) / 180);
                iconCtx.translate(-currentSize / 2, -currentSize / 2);
                iconCtx.drawImage(img, 0, 0, currentSize, currentSize);
                iconCtx.globalCompositeOperation = 'source-in';
                iconCtx.fillStyle = currentColor;
                iconCtx.fillRect(0, 0, currentSize, currentSize);
                ctx.drawImage(iconCanvas, 0, 0);
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentIcon}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              } else if (type === 'svg') {
                const response = await fetch(currentIconUrl, {
                  method: 'GET',
                  mode: 'cors',
                  headers: { 'Accept': 'image/svg+xml' }
                });
                if (!response.ok) throw new Error(`Failed to fetch SVG: ${response.status}`);
                let svgContent = await response.text();
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;
                if (currentRotation !== 0) {
                  const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 24, 24];
                  const centerX = viewBox[2] / 2;
                  const centerY = viewBox[3] / 2;
                  svgElement.setAttribute('transform', `rotate(${currentRotation} ${centerX} ${centerY})`);
                }
                const elements = svgDoc.querySelectorAll('path, rect, circle, polyline, polygon, line');
                elements.forEach(el => {
                  if (el.hasAttribute('fill') && el.getAttribute('fill') !== 'none') {
                    el.setAttribute('fill', currentColor);
                  }
                  if (el.hasAttribute('stroke') && el.getAttribute('stroke') !== 'none') {
                    el.setAttribute('stroke', currentColor);
                    el.setAttribute('stroke-width', currentThickness);
                  } else {
                    el.setAttribute('stroke', currentColor);
                    el.setAttribute('stroke-width', currentThickness);
                  }
                });
                if (currentBg === 'solid' || currentBg === 'gradient') {
                  const rect = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'rect');
                  rect.setAttribute('width', '100%');
                  rect.setAttribute('height', '100%');
                  rect.setAttribute('fill', currentBg === 'solid' ? solidBgColor : `url(#gradient)`);
                  svgElement.insertBefore(rect, svgElement.firstChild);
                  if (currentBg === 'gradient') {
                    const defs = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'defs');
                    const gradient = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                    gradient.setAttribute('id', 'gradient');
                    gradient.setAttribute('x1', '0%');
                    gradient.setAttribute('y1', '0%');
                    gradient.setAttribute('x2', '100%');
                    gradient.setAttribute('y2', '100%');
                    const stop1 = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'stop');
                    stop1.setAttribute('offset', '0%');
                    stop1.setAttribute('stop-color', gradientStartColor);
                    const stop2 = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'stop');
                    stop2.setAttribute('offset', '100%');
                    stop2.setAttribute('stop-color', gradientEndColor);
                    gradient.appendChild(stop1);
                    gradient.appendChild(stop2);
                    defs.appendChild(gradient);
                    svgElement.insertBefore(defs, svgElement.firstChild);
                  }
                }
                svgContent = new XMLSerializer().serializeToString(svgDoc.documentElement);
                const blob = new Blob([svgContent], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentIcon}.svg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
              }
              button.innerHTML = '<i class="fas fa-check"></i> Downloaded!';
              setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
              }, 1000);
            } catch (error) {
              console.error('Download failed:', error);
              button.innerHTML = '<i class="fas fa-times"></i> Failed!';
              setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
              }, 1000);
            }
          });
        });
        downloadButtons[0].hasEventListener = true;
      }
      if (resetButton) {
        resetButton.addEventListener('click', () => {
          resetPanelState();
          updatePreview();
        });
      }
    }

    function applyBackground(ctx, canvas) {
      if (currentBg === 'solid') {
        ctx.fillStyle = solidBgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      } else if (currentBg === 'gradient') {
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, gradientStartColor);
        gradient.addColorStop(1, gradientEndColor);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
    }

    async function updatePreview() {
      if (!currentIcon) return;
      const iconPreview = document.getElementById('icon-preview');
      const iconPath = document.getElementById('icon-path');
      const colorPicker = document.getElementById('icon-color-picker');
      const colorHex = document.getElementById('icon-color-hex');
      const rotationSlider = document.getElementById('rotation-slider');
      const thicknessSlider = document.getElementById('thickness-slider');
      const sizeInput = document.getElementById('custom-size');
      if (!iconPreview || !iconPath || !colorPicker || !colorHex || !rotationSlider || !thicknessSlider || !sizeInput) {
        console.error('Required elements not found in updatePreview');
        return;
      }
      iconPath.innerHTML = `Icons / <span class="font-semibold">${currentIcon}</span>`;
      iconPreview.style.background = '';
      iconPreview.style.backgroundImage = '';
      iconPreview.style.backgroundColor = '';
      iconPreview.style.transform = 'none';
      if (currentBg === 'solid') {
        iconPreview.style.background = solidBgColor;
        iconPreview.style.backgroundImage = 'none';
      } else if (currentBg === 'gradient') {
        iconPreview.style.background = `linear-gradient(135deg, ${gradientStartColor}, ${gradientEndColor})`;
        iconPreview.style.backgroundImage = `linear-gradient(135deg, ${gradientStartColor}, ${gradientEndColor})`;
      } else {
        iconPreview.style.background = 'transparent';
        iconPreview.style.backgroundImage = 'none';
      }
      colorPicker.value = currentColor;
      colorHex.value = currentColor;
      rotationSlider.value = currentRotation;
      thicknessSlider.value = currentThickness;
      sizeInput.value = currentSize;
      try {
        const response = await fetch(currentIconUrl, {
          method: 'GET',
          mode: 'cors',
          headers: { 'Accept': 'image/svg+xml' }
        });
        if (!response.ok) throw new Error(`Failed to fetch SVG: ${response.status}`);
        let svgContent = await response.text();
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
        const svgElement = svgDoc.documentElement;
        const elements = svgDoc.querySelectorAll('path, rect, circle, polyline, polygon, line');
        elements.forEach(el => {
          if (el.hasAttribute('fill') && el.getAttribute('fill') !== 'none') {
            el.setAttribute('fill', currentColor);
          }
          if (el.hasAttribute('stroke') && el.getAttribute('stroke') !== 'none') {
            el.setAttribute('stroke', currentColor);
            el.setAttribute('stroke-width', currentThickness);
          } else {
            el.setAttribute('stroke', currentColor);
            el.setAttribute('stroke-width', currentThickness);
          }
        });
        svgElement.removeAttribute('transform');
        let wrapper = svgDoc.createElementNS('http://www.w3.org/2000/svg', 'g');
        while (svgElement.firstChild) {
          wrapper.appendChild(svgElement.firstChild);
        }
        if (currentRotation !== 0) {
          const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 24, 24];
          const centerX = viewBox[2] / 2;
          const centerY = viewBox[3] / 2;
          wrapper.setAttribute('transform', `rotate(${currentRotation} ${centerX} ${centerY})`);
        }
        svgElement.appendChild(wrapper);
        if (currentZoom !== 1) {
          const viewBox = svgElement.getAttribute('viewBox')?.split(' ').map(Number) || [0, 0, 24, 24];
          const newWidth = viewBox[2] / currentZoom;
          const newHeight = viewBox[3] / currentZoom;
          const newX = viewBox[0] + (viewBox[2] - newWidth) / 2;
          const newY = viewBox[1] + (viewBox[3] - newHeight) / 2;
          svgElement.setAttribute('viewBox', `${newX} ${newY} ${newWidth} ${newHeight}`);
        }
        svgContent = new XMLSerializer().serializeToString(svgDoc.documentElement);
        const previewImg = iconPreview.querySelector('img');
        previewImg.src = `data:image/svg+xml;base64,${btoa(svgContent)}`;
        previewImg.style.width = `${currentSize}px`;
        previewImg.style.height = `${currentSize}px`;
        previewImg.style.transform = 'none';
      } catch (error) {
        console.error('Failed to load icon:', currentIconUrl, error);
        iconPreview.querySelector('img').outerHTML = '<div class="text-red-500">Failed to load icon</div>';
      }
    }

    function filterIcons() {
      const input = document.getElementById('searchInput');
      const filter = input.value.trim().toLowerCase();
      const iconGrid = document.getElementById('iconGrid');
      const iconButtons = iconGrid.querySelectorAll('.icon-button');
      let anyVisible = false;
      iconButtons.forEach(btn => {
        const iconName = btn.getAttribute('data-icon') || '';
        if (iconName.toLowerCase().includes(filter)) {
          btn.style.display = '';
          anyVisible = true;
        } else {
          btn.style.display = 'none';
        }
      });
      // Show/hide the empty message if present
      const emptyMsg = iconGrid.querySelector('.col-span-full');
      if (emptyMsg) {
        emptyMsg.style.display = anyVisible ? 'none' : '';
      }
    }

    function showRightPanel(iconName, iconUrl, element) {
      resetPanelState();
      document.querySelectorAll('.icon-button').forEach(btn => {
        btn.classList.remove('icon-selected');
      });
      if (element) element.classList.add('icon-selected');
      const panel = document.getElementById('right-panel');
      const overlay = document.getElementById('overlay');
      currentIcon = iconName;
      currentIconUrl = iconUrl;
      if (panel) {
        panel.classList.remove('right-panel-hidden');
        panel.classList.add('right-panel-visible');
        panel.style.display = 'block';
      }
      if (overlay) {
        overlay.classList.add('overlay-visible');
      }
      updatePreview();
    }

    function hideRightPanel() {
      const panel = document.getElementById('right-panel');
      const overlay = document.getElementById('overlay');
      if (panel) {
        panel.classList.remove('right-panel-visible');
        panel.classList.add('right-panel-hidden');
        setTimeout(() => {
          panel.style.display = 'none';
        }, 300);
      }
      if (overlay) {
        overlay.classList.remove('overlay-visible');
      }
    }
    // --- END: Popup Panel Logic Parity with home.html ---
  </script>
</body>
</html>