{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>Bundled.icons</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    .collection-active {
      background-color: #E0E7FF;
      color: #4338CA;
      border-radius: 0.375rem;
      padding: 0.5rem 0.75rem;
    }
    .section-highlight {
      box-shadow: 0 10px 15px -3px rgba(67, 56, 202, 0.2);
    }
    .icon-copied {
      background-color: #4338CA !important;
      color: white !important;
    }
    .icon-copied img {
      filter: brightness(0) invert(1);
    }
    .icon-selected {
      border: 2px solid #4338CA !important;
      background-color: #E0E7FF !important;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
    }
    .glass-card h2 {
      color: rgba(255, 255, 255, 0.9);
    }
    .glass-card .bg-indigo-100 {
      background: rgba(99, 102, 241, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }
    .glass-card .icon-button {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }
    .glass-card .icon-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 3px;
    }
    .bg-solid {
      background-color: #f0f0f0;
    }
    .bg-gradient {
      background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
    }
    .right-panel {
      transition: all 0.3s ease-in-out;
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      width: 95%;
      max-width: 900px;
      max-height: 280px;
      background: white;
      border-radius: 16px;
      padding: 1.25rem;
      z-index: 1000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }
    .right-panel-hidden {
      transform: translate(-50%, 150%);
      opacity: 0;
      pointer-events: none;
    }
    .right-panel-visible {
      transform: translate(-50%, 0);
      opacity: 1;
      pointer-events: all;
    }
    .popup-content {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 1.5rem;
      align-items: center;
      height: 100%;
    }
    .popup-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .popup-controls {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .control-group label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.25rem;
    }
    .control-group button {
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      transition: all 0.2s ease;
    }
    .control-group button:hover {
      transform: translateY(-1px);
    }
    .icon-preview {
      width: 100px;
      height: 100px;
      padding: 0.75rem;
      border: 1px solid #E5E7EB;
      border-radius: 12px;
      background: #F9FAFB;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .icon-preview:hover {
      border-color: #D1D5DB;
      background: #F3F4F6;
    }
    .icon-preview img {
      width: 48px;
      height: 48px;
      object-fit: contain;
    }
    .size-button {
      padding: 0.35rem 0.5rem !important;
      font-size: 0.7rem !important;
    }
    #custom-size {
      width: 70px;
      padding: 0.35rem;
      font-size: 0.7rem;
    }
    .copy-button {
      padding: 0.5rem 0.75rem !important;
      font-size: 0.75rem !important;
    }
    #download-img {
      padding: 0.5rem 0.75rem !important;
      font-size: 0.75rem !important;
    }
    #icon-path {
      font-size: 0.75rem;
      color: #6B7280;
    }
    #close-panel {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      color: #6B7280;
      transition: all 0.2s ease;
    }
    #close-panel:hover {
      background: #F3F4F6;
      color: #374151;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease-in-out;
      backdrop-filter: blur(2px);
    }
    .overlay-visible {
      opacity: 1;
      visibility: visible;
    }
    @media (max-width: 768px) {
      .right-panel {
        width: 100%;
        bottom: 0;
        border-radius: 16px 16px 0 0;
        max-height: 320px;
      }
      .popup-content {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      .popup-controls {
        grid-template-columns: 1fr;
      }
      .icon-preview {
        width: 80px;
        height: 80px;
      }
    }
    .glass-sidebar {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-right: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
      position: relative;
    }
    .glass-sidebar a {
      color: rgba(255, 255, 255, 0.8);
      transition: all 0.3s ease;
    }
    .glass-sidebar a:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
      color: rgba(255, 255, 255, 1);
    }
    .glass-sidebar .collection-active {
      background: rgba(99, 102, 241, 0.2);
      color: rgba(255, 255, 255, 0.9);
    }
    .glass-sidebar li {
      transition: all 0.3s ease;
      color: rgba(255, 255, 255, 0.7);
    }
    .glass-sidebar li:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
      color: rgba(255, 255, 255, 1);
    }
    .glass-sidebar li span {
      transition: all 0.3s ease;
    }
    .glass-sidebar li:hover span {
      opacity: 0.7;
    }
    .glass-search {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .glass-search:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .glass-search::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }
    .glass-search:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .glass-button {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }
    .glass-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .glass-button:active {
      transform: translateY(0);
    }
    .icon-button {
      position: relative;
    }
    .icon-button:hover {
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
    }
    .show-more-btn {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    .show-more-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .icon-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
    .icon-grid.hidden-icons .icon-button:nth-child(n+9) {
      display: none;
    }
  </style>
</head>
<body class="bg-black text-[#1F2937]">
  <!-- Debug Information -->
  <div style="display: none;">
    <p>Total Categories: {{ categories|length }}</p>
    <p>Total Icons: {{ icons|length }}</p>
    {% for icon in icons %}
    <p>Icon: {{ icon.name }}, Category: {{ icon.category.name }}, URL: {{ icon.s3_url }}</p>
    {% endfor %}
  </div>

  <!-- Add overlay div -->
  <div id="overlay" class="overlay"></div>
  <div class="flex min-h-screen overflow-hidden">
    <!-- Sidebar -->
    <aside class="flex flex-col w-72 glass-sidebar px-6 py-8 text-sm select-none">
      <div class="flex items-center gap-2 mb-8">
        <img alt="bundled.icons logo" class="w-6 h-6" height="24" src="{% static 'images/bundled.design.png' %}" width="24"/>
        <span class="font-semibold text-base text-white">Bundled.icons</span>
      </div>
      <nav class="mb-10">
        <h3 class="uppercase text-xs font-semibold text-gray-400 mb-3 select-none">Browse</h3>
        <ul class="space-y-2">
          <li>
            <a class="flex items-center gap-2 rounded-md collection-active px-3 py-2 font-medium select-none" href="#" onclick="showAllIcons()"> 
              <i class="fas fa-th text-sm"></i> All Icons
            </a>
          </li>
          <li>
            <a class="flex items-center gap-2 px-3 py-2 rounded-md hover:bg-gray-200 select-none" href="#">
              <i class="fas fa-search text-sm"></i> Search
            </a>
          </li>
        </ul>
      </nav>
      <nav class="flex-1 overflow-y-auto pr-1 scrollbar-thin">
        <h3 class="uppercase text-xs font-semibold text-gray-400 mb-3 select-none">Collections</h3>
        <ul class="space-y-2 text-sm font-normal" id="collections-list">
          {% for category in categories %}
          <li class="cursor-pointer px-3 py-2 rounded-md" onclick="highlightSection('{{ category.name|slugify }}')">
            {{ category.name }} <span class="float-right opacity-40">{{ category.icon_set.count }}</span>
          </li>
          {% endfor %}
        </ul>
      </nav>
      <button class="mt-6 w-full flex items-center justify-center gap-2 rounded-md glass-button py-2 text-sm font-medium" type="button">
        <i class="fas fa-user-circle text-lg"></i> Log in
      </button>
    </aside>
    <!-- Main content -->
    <main class="flex-1 p-6 overflow-y-auto scrollbar-thin">
      <!-- Top bar -->
      <div class="flex items-center gap-4 mb-6">
        <div class="flex-1 relative">
          <input id="searchInput" class="w-full rounded-lg glass-search py-2.5 pl-10 pr-4 text-sm focus:outline-none" placeholder="Search icons..." type="search" oninput="filterIcons()"/>
          <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
        </div>
        <div class="text-gray-400 text-xs select-none whitespace-nowrap">
          Powered by Bundled.design
        </div>
        <button aria-label="User account" class="w-10 h-10 rounded-lg glass-button flex items-center justify-center" type="button">
          <i class="fas fa-user text-gray-300"></i>
        </button>
      </div>
      <!-- Icon grid -->
      <div id="iconGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto max-h-[calc(100vh-120px)] pr-2">
        {% for category in categories %}
        <section id="{{ category.name|slugify }}" class="glass-card rounded-xl p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-semibold text-base select-none">{{ category.name }}</h2>
            <span class="bg-indigo-100 text-indigo-400 text-xs font-semibold rounded-full px-3 py-1 select-none">{{ category.icon_set.count }}</span>
          </div>
          <div class="icon-grid {% if category.icon_set.count >= 8 %}hidden-icons{% endif %}">
            {% for icon in icons %}
            {% if icon.category == category %}
            <button class="rounded-lg p-3 flex items-center justify-center cursor-pointer icon-button" 
                    onclick="showIconPanel('{{ icon.name }}', '{{ category.name }}')" 
                    data-icon="{{ icon.name }}" 
                    data-s3-url="{{ icon.s3_url }}">
              <img alt="{{ icon.name }}" height="24" src="{{ icon.s3_url }}" width="24"/>
            </button>
            {% endif %}
            {% empty %}
            <p class="text-center text-gray-500">No icons found in {{ category.name }}.</p>
            {% endfor %}
          </div>
          {% if category.icon_set.count >= 8 %}
          <button class="show-more-btn w-full mt-4 py-2 rounded-lg text-sm font-medium" onclick="toggleIcons(this, '{{ category.name|slugify }}')">
            Show More
          </button>
          {% endif %}
        </section>
        {% endfor %}
      </div>
    </main>
    <!-- Bottom Popup Panel -->
    <div id="right-panel" class="right-panel right-panel-hidden">
      <div class="popup-content">
        <div class="popup-preview">
          <div class="text-sm" id="icon-path">Icons / <span class="font-semibold" id="icon-name"></span></div>
          <div class="icon-preview" id="icon-preview">
            <img id="preview-img" class="max-w-full max-h-full" width="100" height="100"/>
          </div>
        </div>
        <div class="popup-controls">
          <div class="control-group">
            <label>Icon Color</label>
            <div class="flex items-center gap-2">
              <div aria-hidden="true" class="w-7 h-7 rounded-full bg-black border border-gray-300" id="color-preview"></div>
              <input class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400" id="icon-color" type="text" value="#000000"/>
            </div>
          </div>
          <div class="control-group">
            <label>Background</label>
            <div class="flex items-center gap-2">
              <button class="flex items-center justify-center gap-1 rounded-lg border border-blue-400 bg-blue-50 px-3 py-2 text-sm text-blue-700 bg-button" type="button" data-bg="none"><i class="fas fa-globe"></i>None</button>
              <button class="flex items-center justify-center gap-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 bg-button" type="button" data-bg="solid">Solid</button>
              <button class="flex items-center justify-center gap-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 bg-button" type="button" data-bg="gradient"><i class="fas fa-palette"></i>Gradient</button>
            </div>
          </div>
          <div class="control-group">
            <label>Size</label>
            <div class="flex items-center gap-2 flex-wrap">
              <button class="rounded-lg border border-gray-300 bg-white size-button" type="button" data-size="48">48px</button>
              <button class="rounded-lg border border-gray-300 bg-white size-button" type="button" data-size="64">64px</button>
              <button class="rounded-lg border border-gray-300 bg-white size-button" type="button" data-size="128">128px</button>
              <button class="rounded-lg border border-blue-400 bg-blue-50 text-blue-700 size-button" type="button" data-size="256">256px</button>
              <input class="rounded-lg border border-gray-300" id="custom-size" max="1024" min="1" type="number" value="256"/>
            </div>
          </div>
          <div class="control-group">
            <label>Actions</label>
            <div class="flex items-center gap-2">
              <button class="flex items-center gap-1 rounded-lg border border-gray-300 bg-white copy-button" type="button" data-type="url"><i class="fas fa-link"></i>URL</button>
              <button class="flex items-center gap-1 rounded-lg border border-gray-300 bg-white copy-button" type="button" data-type="base64"><i class="fas fa-image"></i>Base64</button>
              <button class="flex items-center gap-1 rounded-lg bg-blue-700 text-white copy-button" id="download-img" type="button">
                <i class="fas fa-download"></i>Download
              </button>
            </div>
          </div>
        </div>
      </div>
      <button id="close-panel" aria-label="Close" onclick="hideRightPanel()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <script>
    // Global variables for panel state
    let currentIcon = null;
    let currentIconUrl = "";
    let currentColor = "#000000";
    let currentSize = 48;
    let currentBg = "none";
    let isPanelInitialized = false;

    // Initialize panel on page load
    document.addEventListener('DOMContentLoaded', function() {
      initializePanel();
      attachGlobalEventListeners();
      showAllIcons();
    });

    // Attach event listeners to panel elements
    function attachPanelEventListeners() {
      const colorInput = document.getElementById('icon-color');
      const bgButtons = document.querySelectorAll('.bg-button');
      const sizeButtons = document.querySelectorAll('.size-button');
      const copyButtons = document.querySelectorAll('.copy-button');
      const downloadButton = document.getElementById('download-img');
      const sizeInput = document.getElementById('custom-size');

      if (colorInput) {
        colorInput.addEventListener("input", (e) => {
          currentColor = e.target.value;
          updatePreview();
        });
      }

      bgButtons.forEach(button => {
        button.addEventListener("click", () => {
          bgButtons.forEach(btn => {
            btn.classList.remove("border-blue-400", "bg-blue-50", "text-blue-700");
            btn.classList.add("border-gray-300", "bg-white", "text-gray-700");
          });
          button.classList.remove("border-gray-300", "bg-white", "text-gray-700");
          button.classList.add("border-blue-400", "bg-blue-50", "text-blue-700");
          currentBg = button.dataset.bg;
          updatePreview();
        });
      });

      sizeButtons.forEach(button => {
        button.addEventListener("click", () => {
          sizeButtons.forEach(btn => {
            btn.classList.remove("border-blue-400", "bg-blue-50", "text-blue-700");
            btn.classList.add("border-gray-300", "bg-white", "text-gray-700");
          });
          button.classList.remove("border-gray-300", "bg-white", "text-gray-700");
          button.classList.add("border-blue-400", "bg-blue-50", "text-blue-700");
          currentSize = parseInt(button.dataset.size);
          updatePreview();
        });
      });

      if (sizeInput) {
        sizeInput.addEventListener("input", (e) => {
          const size = parseInt(e.target.value);
          if (size >= 1 && size <= 1024) {
            currentSize = size;
            sizeButtons.forEach(btn => {
              btn.classList.remove("border-blue-400", "bg-blue-50", "text-blue-700");
              btn.classList.add("border-gray-300", "bg-white", "text-gray-700");
            });
            updatePreview();
          }
        });
      }

      copyButtons.forEach(button => {
        button.addEventListener("click", () => {
          const type = button.dataset.type;
          let text = "";
          if (type === "url") {
            text = currentIconUrl;
          } else if (type === "base64") {
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = currentIconUrl;
            img.onload = () => {
              const canvas = document.createElement("canvas");
              canvas.width = currentSize;
              canvas.height = currentSize;
              const ctx = canvas.getContext("2d");
              ctx.fillStyle = currentBg === "solid" ? "#f0f0f0" : currentBg === "gradient" ? "linear-gradient(135deg, #a1c4fd, #c2e9fb)" : "transparent";
              ctx.fillRect(0, 0, canvas.width, canvas.height);
              ctx.drawImage(img, 0, 0, currentSize, currentSize);
              text = canvas.toDataURL("image/png");
              navigator.clipboard.writeText(text).then(() => {
                const originalContent = button.innerHTML;
                button.textContent = "Copied!";
                setTimeout(() => {
                  button.innerHTML = originalContent;
                }, 1000);
              });
            };
            return;
          }
          navigator.clipboard.writeText(text).then(() => {
            const originalContent = button.innerHTML;
            button.textContent = "Copied!";
            setTimeout(() => {
              button.innerHTML = originalContent;
            }, 1000);
          });
        });
      });

      if (downloadButton) {
        downloadButton.addEventListener("click", async () => {
          const originalContent = downloadButton.innerHTML;
          try {
            // Debug logging
            console.log('Download URL:', currentIconUrl);
            console.log('Icon name:', currentIcon);
            
            // Show loading state
            downloadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Downloading...';
            downloadButton.disabled = true;

            // Try to fetch with specific headers
            const response = await fetch(currentIconUrl, {
              method: 'GET',
              mode: 'cors',
              headers: {
                'Accept': 'image/svg+xml',
                'Origin': window.location.origin
              }
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));

            if (!response.ok) {
              throw new Error(`Failed to fetch SVG: ${response.status} ${response.statusText}`);
            }

            const svgContent = await response.text();
            console.log('SVG content length:', svgContent.length);

            // Create a blob URL
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const blobUrl = URL.createObjectURL(blob);

            // Create a temporary link to download the file
            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = `${currentIcon}.svg`;
            document.body.appendChild(a);
            a.click();
            
            // Clean up
            document.body.removeChild(a);
            URL.revokeObjectURL(blobUrl);

            // Show success message
            downloadButton.innerHTML = '<i class="fas fa-check"></i>Downloaded!';
            setTimeout(() => {
              downloadButton.innerHTML = originalContent;
              downloadButton.disabled = false;
            }, 1000);
          } catch (error) {
            console.error('Download failed:', error);
            console.error('Error details:', {
              name: error.name,
              message: error.message,
              stack: error.stack
            });
            // Show error message
            downloadButton.innerHTML = '<i class="fas fa-times"></i>Failed!';
            setTimeout(() => {
              downloadButton.innerHTML = originalContent;
              downloadButton.disabled = false;
            }, 1000);
          }
        });
      }
    }

    // Initialize panel structure
    function initializePanel() {
      const panel = document.getElementById('right-panel');
      if (!panel) {
        console.error('Panel element not found');
        return;
      }

      // Create panel structure if it doesn't exist
      if (!panel.querySelector('.popup-content')) {
        panel.innerHTML = `
          <div class="popup-content">
            <div class="popup-preview">
              <div class="text-sm" id="icon-path">Icons / <span class="font-semibold" id="icon-name"></span></div>
              <div class="icon-preview" id="icon-preview">
                <img id="preview-img" class="max-w-full max-h-full" width="100" height="100"/>
              </div>
            </div>
            <div class="popup-controls">
              <div class="control-group">
                <label>Icon Color</label>
                <div class="flex items-center gap-2">
                  <div aria-hidden="true" class="w-7 h-7 rounded-full bg-black border border-gray-300" id="color-preview"></div>
                  <input class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-400" id="icon-color" type="text" value="#000000"/>
                </div>
              </div>
              <div class="control-group">
                <label>Background</label>
                <div class="flex items-center gap-2">
                  <button class="flex items-center justify-center gap-1 rounded-lg border border-blue-400 bg-blue-50 px-3 py-2 text-sm text-blue-700 bg-button" type="button" data-bg="none"><i class="fas fa-globe"></i>None</button>
                  <button class="flex items-center justify-center gap-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 bg-button" type="button" data-bg="solid">Solid</button>
                  <button class="flex items-center justify-center gap-1 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 bg-button" type="button" data-bg="gradient"><i class="fas fa-palette"></i>Gradient</button>
                </div>
              </div>
              <div class="control-group">
                <label>Size</label>
                <div class="flex items-center gap-2 flex-wrap">
                  <button class="rounded-lg border border-gray-300 bg-white size-button" type="button" data-size="48">48px</button>
                  <button class="rounded-lg border border-gray-300 bg-white size-button" type="button" data-size="64">64px</button>
                  <button class="rounded-lg border border-gray-300 bg-white size-button" type="button" data-size="128">128px</button>
                  <button class="rounded-lg border border-blue-400 bg-blue-50 text-blue-700 size-button" type="button" data-size="256">256px</button>
                  <input class="rounded-lg border border-gray-300" id="custom-size" max="1024" min="1" type="number" value="256"/>
                </div>
              </div>
              <div class="control-group">
                <label>Actions</label>
                <div class="flex items-center gap-2">
                  <button class="flex items-center gap-1 rounded-lg border border-gray-300 bg-white copy-button" type="button" data-type="url"><i class="fas fa-link"></i>URL</button>
                  <button class="flex items-center gap-1 rounded-lg border border-gray-300 bg-white copy-button" type="button" data-type="base64"><i class="fas fa-image"></i>Base64</button>
                  <button class="flex items-center gap-1 rounded-lg bg-blue-700 text-white copy-button" id="download-img" type="button">
                    <i class="fas fa-download"></i>Download
                  </button>
                </div>
              </div>
            </div>
          </div>
          <button id="close-panel" aria-label="Close" onclick="hideRightPanel()">
            <i class="fas fa-times"></i>
          </button>
        `;
      }

      // Attach event listeners
      attachPanelEventListeners();
      isPanelInitialized = true;
    }

    // Attach global event listeners
    function attachGlobalEventListeners() {
      // Close panel when clicking outside
      document.addEventListener('mousedown', function(event) {
        const panel = document.getElementById('right-panel');
        const overlay = document.getElementById('overlay');
        if (panel && panel.style.display === 'block' && !panel.contains(event.target) && !event.target.classList.contains('icon-button')) {
          hideRightPanel();
        }
      });

      // Close panel when clicking overlay
      const overlay = document.getElementById('overlay');
      if (overlay) {
        overlay.addEventListener('click', hideRightPanel);
      }
    }

    // Show right panel and select icon
    function showIconPanel(iconName, category) {
      console.log('Starting showIconPanel with:', { iconName, category });
      
      // Ensure panel is initialized
      if (!isPanelInitialized) {
        console.log('Panel not initialized, initializing now...');
        initializePanel();
      }
      
      // Get the icon element and its S3 URL
      const iconElement = document.querySelector(`button[data-icon="${iconName}"]`);
      if (!iconElement) {
        console.error(`Icon element not found: ${iconName}`);
        return;
      }
      
      const iconUrl = iconElement.dataset.s3Url;
      if (!iconUrl) {
        console.error(`S3 URL not found for icon: ${iconName}`);
        return;
      }
      
      // Get panel elements
      const panel = document.getElementById('right-panel');
      const iconPreview = document.getElementById('icon-preview');
      const iconPath = document.getElementById('icon-path');
      const overlay = document.getElementById('overlay');
      
      if (!panel || !iconPreview || !iconPath || !overlay) {
        console.error('Required elements not found. Panel initialized:', isPanelInitialized);
        console.error('Panel:', !!panel);
        console.error('Icon Preview:', !!iconPreview);
        console.error('Icon Path:', !!iconPath);
        console.error('Overlay:', !!overlay);
        return;
      }
      
      // Set current icon data
      currentIcon = iconName;
      currentIconUrl = iconUrl;
      
      // Update UI
      iconPath.innerHTML = `Icons / ${category} / <span class="font-semibold">${iconName}</span>`;
      
      // Show panel and overlay
      panel.style.display = 'block';
      setTimeout(() => {
        panel.classList.remove('right-panel-hidden');
        panel.classList.add('right-panel-visible');
        overlay.classList.add('overlay-visible');
      }, 10);
      
      // Load the icon
      const img = new Image();
      img.onload = function() {
        iconPreview.innerHTML = `<img src="${iconUrl}" width="${currentSize}" height="${currentSize}" style="object-fit: contain;"/>`;
      };
      img.onerror = function() {
        console.error('Failed to load icon:', iconUrl);
        iconPreview.innerHTML = '<div class="text-red-500">Failed to load icon</div>';
      };
      img.src = iconUrl;
      
      // Highlight selected icon
      document.querySelectorAll('.icon-button').forEach(btn => {
        btn.classList.remove('icon-selected');
      });
      iconElement.classList.add('icon-selected');
    }

    // Hide right panel
    function hideRightPanel() {
      const panel = document.getElementById('right-panel');
      const overlay = document.getElementById('overlay');
      
      if (!panel || !overlay) return;
      
      panel.classList.remove('right-panel-visible');
      panel.classList.add('right-panel-hidden');
      overlay.classList.remove('overlay-visible');
      
      setTimeout(() => {
        panel.style.display = 'none';
      }, 300);
      
      currentIcon = null;
      document.querySelectorAll('.icon-button').forEach(btn => {
        btn.classList.remove('icon-selected');
      });
    }

    // Update preview
    function updatePreview() {
      if (!currentIcon) return;
      
      const iconPreview = document.getElementById('icon-preview');
      const iconPath = document.getElementById('icon-path');
      const colorPreview = document.getElementById('color-preview');
      const colorInput = document.getElementById('icon-color');
      const sizeInput = document.getElementById('custom-size');
      
      if (!iconPreview || !iconPath || !colorPreview || !colorInput || !sizeInput) {
        console.error('Required elements not found in updatePreview');
        return;
      }
      
      // Update icon path with current icon name
      const currentPath = iconPath.textContent.split('/').slice(0, -1).join('/');
      iconPath.innerHTML = `${currentPath} / <span class="font-semibold">${currentIcon}</span>`;
      
      iconPreview.className = `border border-gray-200 rounded-lg p-6 mb-6 grid place-items-center bg-${currentBg}`;
      colorPreview.style.backgroundColor = currentColor;
      colorInput.value = currentColor;
      sizeInput.value = currentSize;

      // Load the icon
      const img = new Image();
      img.onload = function() {
        iconPreview.innerHTML = `<img src="${currentIconUrl}" width="${currentSize}" height="${currentSize}" style="object-fit: contain;"/>`;
      };
      img.onerror = function() {
        console.error('Failed to load icon:', currentIconUrl);
        iconPreview.innerHTML = '<div class="text-red-500">Failed to load icon</div>';
      };
      img.src = currentIconUrl;
    }

    // Highlight section
    function highlightSection(collectionName) {
      document.querySelectorAll('.collection-active').forEach(el => el.classList.remove('collection-active'));
      document.querySelectorAll('.section-highlight').forEach(el => el.classList.remove('section-highlight'));

      const collectionItems = document.querySelectorAll('#collections-list li');
      collectionItems.forEach(item => {
        if (item.textContent.toLowerCase().includes(collectionName.replace(/-/g, ' '))) {
          item.classList.add('collection-active');
        }
      });

      const section = document.getElementById(collectionName);
      if (section) {
        section.classList.add('section-highlight');
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    // Show all icons
    function showAllIcons() {
      document.querySelectorAll('.collection-active').forEach(el => el.classList.remove('collection-active'));
      document.querySelectorAll('.section-highlight').forEach(el => el.classList.remove('section-highlight'));
      currentIcon = null;
      document.querySelectorAll('#iconGrid section').forEach(section => {
        section.style.display = 'block';
      });
      hideRightPanel();
    }

    // Filter icons
    function filterIcons() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const sections = document.querySelectorAll('#iconGrid section');

      sections.forEach(section => {
        const title = section.querySelector('h2').textContent.toLowerCase();
        const icons = section.querySelectorAll('.icon-button');
        let hasVisibleIcons = false;

        icons.forEach(icon => {
          const altText = icon.querySelector('img')?.alt.toLowerCase() || '';
          if (altText.includes(searchTerm) || title.includes(searchTerm)) {
            icon.parentElement.style.display = 'flex';
            hasVisibleIcons = true;
          } else {
            icon.parentElement.style.display = 'none';
          }
        });

        section.style.display = hasVisibleIcons ? 'block' : 'none';
      });
    }

    // Toggle icons visibility
    function toggleIcons(button, categoryId) {
      const section = document.getElementById(categoryId);
      const iconGrid = section.querySelector('.icon-grid');
      const isExpanded = button.textContent.trim() === 'Show Less';
      
      if (isExpanded) {
        iconGrid.classList.add('hidden-icons');
        button.textContent = 'Show More';
      } else {
        iconGrid.classList.remove('hidden-icons');
        button.textContent = 'Show Less';
      }
    }
  </script>
</body>
</html>